name: Java CI with Publish to Packages (JDK 21)

on:
  push:
    branches:
      - feature/**  # Run on pushes to feature branches
  pull_request:
    branches:
      - main  # Run on pull requests to main branch

jobs:
  build-test-publish:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Don't stop the workflow on a single job failure
      matrix:
        java: [21]  # Test with JDK 21
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ matrix.java }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Install dependencies
        run: mvn install

      - name: Run tests
        run: mvn test

      - name: Build JAR (if build script exists)
        run: mvn package  # Assuming your build script uses 'package' goal

      - name: Publish JAR to GitHub Packages (on main branch merge)
        uses: actions/upload-artifact@v4  # Upload JAR for potential download later
        with:
          if: ${{ github.event.name == 'pull_request' && github.event.pull_request.merged == true }}
          name: ${{ github.sha }}.jar  # Name the artifact with commit SHA
          path: target/*.jar  # Assuming your JAR is in the target directory

      - uses: nathangitter/publish-to-github-packages@v4  # Publish to Packages action
        with:
          if: ${{ github.event.name == 'pull_request' && github.event.pull_request.merged == true }}
          access_token: ${{ secrets.GITHUB_TOKEN }}  # Use a PAT with publish:packages scope
          package_name: smart-pos  # Replace with your package name
          token: ${{ secrets.GITHUB_TOKEN }}  # Use the same PAT for publishing
